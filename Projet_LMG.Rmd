---
title: "Projet : Modèle Linéaire Généralisé / Choix de Modèle - R   "     
author: "Marlène Chevalier"
date: "31/08/2019  "       
output:
    html_document:
      toc: yes
      toc_depth: 3
      number_sections: 3
      toc_float: yes
---

<style type="text/css">
body{ /* Normal  */
font-size: 12px;
}
td {  /* Table  */
font-size: 12px;
}
h1.title {
font-size: 26px;
color: Blue;
}

h1 { /* Header 1 */
font-size: 20px;
color: Blue;
}
h2 { /* Header 2 */
font-size: 16px;
color: Blue;
}
h3 { /* Header 3 */
font-size: 14px;
font-family: "Times New Roman", Times, serif;
color: Blue;
}
</style>

<style>
#TOC {
  color: Blue; 
}

</style>


```{r setup, echo=FALSE, message=FALSE,warning=FALSE }
#packages utilisés
library(knitr)
library(tidyverse)
library(gridExtra)
library(kableExtra)
library(plotly)
library(leaps)

# parametrage des graphiques
theme_set=(theme_classic()+theme(plot.title=element_text(hjust=0.5,size=14,face="bold"),plot.subtitle=element_text(hjust=0.5,size=12) ,axis.title=element_text(size=10)))  

# chunk : options globales
opts_chunk$set(echo=FALSE,
               fig.align = "center",
               fig.retina = 2,
               fig.height=4,
               fig.width = 7
                # cache = TRUE
               # cache.lazy = FALSE
                )
```

    
        
# Sujet : Pluie à Bâle  

Il s'agit de proposer et valider un modèle qui permettra d'expliquer et de prédire la présence de pluie le jour suivant à Bâle.
Pour ce faire, les données disponibles sont sous forme de 2 fichiers : 

  - un fichier d'entrainement *meteo.train.csv*
  - un fichier test *meteo.test.csv* 

Ces deux fichiers contiennent des données météorologiques quotidiennes  enregistrées sur des journées entre juin 2010 et juin 2018 :  

  - Valeurs moyenne, minimale et maximale :  
      - Température (°C), 
      - Humidité relative (%), 
      - Pression (hPa), 
      - Nébulosité (%) : 
          Nébulosité forte (ciel élevé :  entre 7 et 13 km d'altitude) / 
          Nébulosité moyenne (ciel moyen: entre 2 et 7km d'altitude) / 
          Nébulosité faible (ciel bas : jusqu'à 2 km), 
      - Vitesse (km/h) selon l'altitude(10m / 80m / altitude avec 900hPa),  
      - Direction du vent (°) selon l'altitude(10m / 80m / altitude avec 900hPa),      
      - Rafale de vent à 10 mètres (km/h)     
      
      
  - Valeur Totale :   
      - Précipitations (mm),   
      - Neige (cm),   
      - Ensoleillement (minutes),   
      - Rayonnement solaire (W/m²)  

Le fichier d'entrainement contient, en plus, la colonne *pluie.demain* qui indique la prédiction de pluie pour le lendemain. 
Il s'agit de proposer une prediction *pluie.demain* qui sera à inclure dans le fichier test.
Cette prédiction sera donc basée sur les conditions météorologiques de la veille. 

# Exploration des données
```{r explo, include=FALSE}
## Chargement du jeu de données : base entrainement et base test 
d.train=read.table("meteo.train.csv",header=TRUE,sep=",", na.string="")
d.test=read.table("meteo.test.csv",header=TRUE,sep=",", na.string="")
attach(d.train)

##Résumé des données
dim(d.train)
dim(d.test)

train.row=nrow(d.train)
train.col=ncol(d.train)
test.row=nrow(d.test)
test.col=ncol(d.test)

##Renommer les variables de la base d'entrainement
colnames(d.train)[colnames(d.train)=="Temperature.daily.mean..2.m.above.gnd."]<-"Temp.mean"
colnames(d.train)[colnames(d.train)=="Temperature.daily.max..2.m.above.gnd."]<-"Temp.max"
colnames(d.train)[colnames(d.train)=="Temperature.daily.min..2.m.above.gnd."]<-"Temp.min"
colnames(d.train)[colnames(d.train)=="Relative.Humidity.daily.mean..2.m.above.gnd."]="Humid.mean"
colnames(d.train)[colnames(d.train)=="Relative.Humidity.daily.max..2.m.above.gnd."]="Humid.max"
colnames(d.train)[colnames(d.train)=="Relative.Humidity.daily.min..2.m.above.gnd."]="Humid.min"
colnames(d.train)[colnames(d.train)=="Mean.Sea.Level.Pressure.daily.mean..MSL."]="Pressure.mean"
colnames(d.train)[colnames(d.train)=="Mean.Sea.Level.Pressure.daily.max..MSL."]="Pressure.max"
colnames(d.train)[colnames(d.train)=="Mean.Sea.Level.Pressure.daily.min..MSL."]="Pressure.min"
colnames(d.train)[colnames(d.train)=="Total.Precipitation.daily.sum..sfc."]="Precip.tot"
colnames(d.train)[colnames(d.train)=="Snowfall.amount.raw.daily.sum..sfc." ]="Snow.tot"
colnames(d.train)[colnames(d.train)=="Total.Cloud.Cover.daily.mean..sfc." ]="TotalCloud.mean"
colnames(d.train)[colnames(d.train)=="High.Cloud.Cover.daily.mean..high.cld.lay." ]="HighCloud.mean"
colnames(d.train)[colnames(d.train)=="Medium.Cloud.Cover.daily.mean..mid.cld.lay." ]="MediumCloud.mean"
colnames(d.train)[colnames(d.train)=="Low.Cloud.Cover.daily.mean..low.cld.lay." ]="LowCloud.mean"
colnames(d.train)[colnames(d.train)=="Total.Cloud.Cover.daily.max..sfc." ]="TotalCloud.max"
colnames(d.train)[colnames(d.train)=="High.Cloud.Cover.daily.max..high.cld.lay." ]="HighCloud.max"
colnames(d.train)[colnames(d.train)=="Medium.Cloud.Cover.daily.max..mid.cld.lay." ]="MediumCloud.max"
colnames(d.train)[colnames(d.train)=="Low.Cloud.Cover.daily.max..low.cld.lay." ]="LowCloud.max"
colnames(d.train)[colnames(d.train)=="Total.Cloud.Cover.daily.min..sfc." ]="TotalCloud.min"
colnames(d.train)[colnames(d.train)=="High.Cloud.Cover.daily.min..high.cld.lay." ]="HighCloud.min"
colnames(d.train)[colnames(d.train)=="Medium.Cloud.Cover.daily.min..mid.cld.lay." ]="MediumCloud.min"
colnames(d.train)[colnames(d.train)=="Low.Cloud.Cover.daily.min..low.cld.lay." ]="LowCloud.min"
colnames(d.train)[colnames(d.train)=="Sunshine.Duration.daily.sum..sfc." ]="Sunshine.tot"
colnames(d.train)[colnames(d.train)=="Shortwave.Radiation.daily.sum..sfc." ]="Shortwave.tot"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.mean..10.m.above.gnd." ]="WindSpeed10m.mean"
colnames(d.train)[colnames(d.train)=="Wind.Direction.daily.mean..10.m.above.gnd." ]="WindDir10m.mean"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.mean..80.m.above.gnd." ]="WindSpeed80m.mean"
colnames(d.train)[colnames(d.train)== "Wind.Direction.daily.mean..80.m.above.gnd." ]="WindDir80m.mean"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.mean..900.mb." ]="WindSpeed900mb.mean"
colnames(d.train)[colnames(d.train)== "Wind.Direction.daily.mean..900.mb."  ]="WindDir900mb.mean"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.max..10.m.above.gnd." ]="WindSpeed10m.max"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.max..80.m.above.gnd." ]="WindSpeed80m.max"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.max..900.mb." ]="WindSpeed900mb.max"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.min..10.m.above.gnd." ]="WindSpeed10m.min"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.min..80.m.above.gnd." ]="WindSpeed80m.min"
colnames(d.train)[colnames(d.train)=="Wind.Speed.daily.min..900.mb." ]="WindSpeed900mb.min"
colnames(d.train)[colnames(d.train)=="Wind.Gust.daily.mean..sfc." ]="WindGust.mean"
colnames(d.train)[colnames(d.train)=="Wind.Gust.daily.max..sfc."  ]="WindGust.max"
colnames(d.train)[colnames(d.train)=="Wind.Gust.daily.min..sfc."  ]="WindGust.min"

##Remplacer la valeur de pluie.demain (True <-1;False <-0)
d.train$pluie.demain.bin[(d.train$pluie.demain)==TRUE]=1
d.train$pluie.demain.bin[(d.train$pluie.demain)==FALSE]=0


##Renommer les variables de la base test
colnames(d.test)[colnames(d.test)=="Temperature.daily.mean..2.m.above.gnd."]<-"Temp.mean"
colnames(d.test)[colnames(d.test)=="Temperature.daily.max..2.m.above.gnd."]<-"Temp.max"
colnames(d.test)[colnames(d.test)=="Temperature.daily.min..2.m.above.gnd."]<-"Temp.min"
colnames(d.test)[colnames(d.test)=="Relative.Humidity.daily.mean..2.m.above.gnd."]="Humid.mean"
colnames(d.test)[colnames(d.test)=="Relative.Humidity.daily.max..2.m.above.gnd."]="Humid.max"
colnames(d.test)[colnames(d.test)=="Relative.Humidity.daily.min..2.m.above.gnd."]="Humid.min"
colnames(d.test)[colnames(d.test)=="Mean.Sea.Level.Pressure.daily.mean..MSL."]="Pressure.mean"
colnames(d.test)[colnames(d.test)=="Mean.Sea.Level.Pressure.daily.max..MSL."]="Pressure.max"
colnames(d.test)[colnames(d.test)=="Mean.Sea.Level.Pressure.daily.min..MSL."]="Pressure.min"
colnames(d.test)[colnames(d.test)=="Total.Precipitation.daily.sum..sfc."]="Precip.tot"
colnames(d.test)[colnames(d.test)=="Snowfall.amount.raw.daily.sum..sfc." ]="Snow.tot"
colnames(d.test)[colnames(d.test)=="Total.Cloud.Cover.daily.mean..sfc." ]="TotalCloud.mean"
colnames(d.test)[colnames(d.test)=="High.Cloud.Cover.daily.mean..high.cld.lay." ]="HighCloud.mean"
colnames(d.test)[colnames(d.test)=="Medium.Cloud.Cover.daily.mean..mid.cld.lay." ]="MediumCloud.mean"
colnames(d.test)[colnames(d.test)=="Low.Cloud.Cover.daily.mean..low.cld.lay." ]="LowCloud.mean"
colnames(d.test)[colnames(d.test)=="Total.Cloud.Cover.daily.max..sfc." ]="TotalCloud.max"
colnames(d.test)[colnames(d.test)=="High.Cloud.Cover.daily.max..high.cld.lay." ]="HighCloud.max"
colnames(d.test)[colnames(d.test)=="Medium.Cloud.Cover.daily.max..mid.cld.lay." ]="MediumCloud.max"
colnames(d.test)[colnames(d.test)=="Low.Cloud.Cover.daily.max..low.cld.lay." ]="LowCloud.max"
colnames(d.test)[colnames(d.test)=="Total.Cloud.Cover.daily.min..sfc." ]="TotalCloud.min"
colnames(d.test)[colnames(d.test)=="High.Cloud.Cover.daily.min..high.cld.lay." ]="HighCloud.min"
colnames(d.test)[colnames(d.test)=="Medium.Cloud.Cover.daily.min..mid.cld.lay." ]="MediumCloud.min"
colnames(d.test)[colnames(d.test)=="Low.Cloud.Cover.daily.min..low.cld.lay." ]="LowCloud.min"
colnames(d.test)[colnames(d.test)=="Sunshine.Duration.daily.sum..sfc." ]="Sunshine.tot"
colnames(d.test)[colnames(d.test)=="Shortwave.Radiation.daily.sum..sfc." ]="Shortwave.tot"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.mean..10.m.above.gnd." ]="WindSpeed10m.mean"
colnames(d.test)[colnames(d.test)=="Wind.Direction.daily.mean..10.m.above.gnd." ]="WindDir10m.mean"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.mean..80.m.above.gnd." ]="WindSpeed80m.mean"
colnames(d.test)[colnames(d.test)== "Wind.Direction.daily.mean..80.m.above.gnd." ]="WindDir80m.mean"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.mean..900.mb." ]="WindSpeed900mb.mean"
colnames(d.test)[colnames(d.test)== "Wind.Direction.daily.mean..900.mb."  ]="WindDir900mb.mean"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.max..10.m.above.gnd." ]="WindSpeed10m.max"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.max..80.m.above.gnd." ]="WindSpeed80m.max"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.max..900.mb." ]="WindSpeed900mb.max"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.min..10.m.above.gnd." ]="WindSpeed10m.min"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.min..80.m.above.gnd." ]="WindSpeed80m.min"
colnames(d.test)[colnames(d.test)=="Wind.Speed.daily.min..900.mb." ]="WindSpeed900mb.min"
colnames(d.test)[colnames(d.test)=="Wind.Gust.daily.mean..sfc." ]="WindGust.mean"
colnames(d.test)[colnames(d.test)=="Wind.Gust.daily.max..sfc."  ]="WindGust.max"
colnames(d.test)[colnames(d.test)=="Wind.Gust.daily.min..sfc."  ]="WindGust.min"


```
Le fichier metéo *entrainement* contient `r train.row` lignes et `r train.col` colonnes.   
Le fichier metéo *test* contient `r test.row` lignes et `r test.col` colonnes.

##Les précipitations mensuelles

A Bâle, les précipitations sont en moyenne plus abondantes entre mai et août. Les niveaux moyens sont néanmoins assez proches d'un mois sur l'autre ( entre 1mm et 2.8 mm *cf.graphe 1*) et les niveaux journaliers sont souvent loin de ces moyennes (dispersion importante *cf.graphe 2*).

Sur la période observée (1244 journées entre juin 2010 et juin 2018), il a plu 647 jours soit une probabilité observée de présence de pluie de 52,2%. C'est en mai, juin et juillet que la proportion de journées pluvieuses est la plus importante (elle atteint 68% en juin) ; et en mars, septembre et novembre au contraire, elle ne représente qu'environ 40%.(à partir du *graphe 3*)

```{r plotprecipmens}
# calcul des précipitations mensuelles : moy, var, min, max
d.precipmonth =
d.train %>% 
  group_by(Month) %>% 
  summarise (
  MeanPrecip =mean(Precip.tot, na.rm=T),
  VarPrecip =var(Precip.tot),
  MinPrecip =min(Precip.tot, na.rm=F),
  MaxPrecip =max(Precip.tot, na.rm=F))

# graphique des precipitations mensuelles moyennes

theme_set(theme_classic()+theme(plot.title=element_text(hjust=0.5,size=14,face="bold"),plot.subtitle=element_text(hjust=0.5,size=12) ,axis.title=element_text(hjust=1,size=10))) 

# graphique p1 : précipitations mensuelles moyennes
p1=ggplot(data=d.precipmonth, mapping=aes(x = as.factor(Month), y = MeanPrecip)) +
  geom_bar(stat="identity", col="black",fill="blue",width = 1) + 
  labs(subtitle="graphe1 : Moyenne",x="", y="Précipitations (mm)" ) +  
  scale_y_continuous(breaks=seq(0,3,0.5),limits=c(0,3)) +
  scale_x_discrete(labels=c("Jan","Fev","Mar","Avr","Mai","Juin","Juil","Aou", "Sep", "Oct","Nov","Dec"))

# graphique p2 : précipitations mensuelles moyennes et extremes
p2=ggplot(data=d.train, mapping=aes(x = as.factor(Month), y = Precip.tot)) +
  geom_boxplot(fill="blue", width = 1) + 
  labs(subtitle="graphe 2 : Moyenne et Extrèmes",x="",y="Précipitations (mm)" ) +
  scale_x_discrete(labels=c("Jan","Fev","Mar","Avr","Mai","Juin","Juil","Aou", "Sep", "Oct","Nov","Dec"))

grid.arrange(p1,p2,ncol=2,top="Précipitations mensuelles à Bâle entre 2010 et 2018")
       
```



```{r sanspluie}
#Compter le nombre de jours de pluie et sans pluie
d.train$pluie.auj=NA
d.train$pluie.auj[(d.train$Precip.tot)!=0]=TRUE # jour avec pluie
d.train[which(is.na(d.train[,"pluie.auj"])),"pluie.auj"]=FALSE # jour sans pluie

# graphique des jours avec et sans pluie
theme_set(theme_classic()+theme(plot.title=element_text(hjust=0.5,size=14,face="bold"),plot.subtitle=element_text(hjust=0.5,size=12),axis.title=element_text(hjust=1,size=10)))

ggplot(data=d.train, mapping=aes(x = as.factor(Month), fill=pluie.auj)) +
  labs(subtitle="graphe 3 : Nombre de jours avec et sans pluie", x="", y="Nombre de jours", fill="" ) +
  geom_bar(col="black", position ="dodge") +
  scale_x_discrete(labels=c("Jan","Fev","Mar","Avr","Mai","Juin","Juil","Aou", "Sep", "Oct","Nov","Dec")) + 
 scale_fill_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))
```

##Les observations liées aux prévisions de précipitations

Examinons maintenant le comportement des variables météorologiques au regard de la prédiction qui a été faite pour le lendemain.

  - La température du jour semble peu influencer les prévisions du lendemain (*cf. graphe 5* : le niveau médian de température est proche quelle que soit la prévision pour le lendemain). Le *graphe 4* ne montre pas non plus d'influence particulière de la température du jour sur la prévision du lendemain (répartition similaire des prévisions de journées pluvieuses ou non) Par contre lorsque le niveau de précipitation du jour est important, on aura tendance à prévoir de la pluie pour le lendemain (points bleus plus représentéés pour un niveau élévé de précipitations)
  
  - Le taux d'humidité du jour ne semble pas non plus avoir une influence marquante sur les prévisions météo (*cf graphe 7* : le niveau médian d'humidité du jour est très légèrement plus élevé lorsque on prévoit de la pluie).
  
   - **La pression athmosphérique du jour**, par contre, semble être un indicateur pour prévoir le temps du lendemain : en effet, on voit très clairement que le niveau médian est bas lorqu'on prévoit de la pluie pour le lendemain (*cf. graphe 9*). 
   
  - **La nébulosité du jour** semble aussi annoncer le temps du lendemain : plus elle est importante, plus on aura tendance à prévoir de la pluie pour le lendemain (*cf. graphe 11* : niveau médian de nébulosité plus fort lorsqu'on prévoit de la pluie). 
  
  - **La durée d'enseillement du jour** a également une influence sur les prévisions du lendemain : moins l'ensoleillement est important, plus on aura tendance à prévoir de la pluie pour le lendemain (*cf. graphe 13* : le niveau médian du temps d'ensoleillement ).
  
   - **Les rafales de vent** ont également une influence sur les prévisions du lendemain (*cf. graphe 15* : le niveau médian des vitesses de rafale de vent est plus important lorsqu'on prévoit de la pluie).
   
   - **La vitesse et la direction du vent** de la journée semblent impacter significativement les prévisions pour le lendemain (*cf. graphes 16 à 24*). Les vents du nord et d'ouest amènent des pluie plus abondantes que les vents du sud et d'est (*cf. graphes 16 à 18*).
Les vents d'ouest quelque soit leur vitesse sont souvent signe de pluie en journée et conduit à prévoir une journée du lendemain pluvieuse (*cf. graphes 19 à 24*).

Avec ces observations graphiques, on a l'impression que la pression athmosphérique, la nébulosité, l'ensoleillement, les caractéristiques du vent d'une journée ont un impact sur la prévision météo pour le lendemain.

```{r lienvar}
# calcul des directions de vent par quart N-E-S-O : WindDir10m.mean.quart / WindDir80m.mean.quart / WindDir900mb.mean.quart 
d.train$QuartWDir10m=NA
d.train$QuartWDir10m[(d.train$WindDir10m.mean<45)|(d.train$WindDir10m.mean>=315)]="Nord"
d.train$QuartWDir10m[(d.train$WindDir10m.mean<135)&(d.train$WindDir10m.mean>=45)]="Est"
d.train$QuartWDir10m[(d.train$WindDir10m.mean<225)&(d.train$WindDir10m.mean>=135)]="Sud"
d.train$QuartWDir10m[(d.train$WindDir10m.mean<315)&(d.train$WindDir10m.mean>=225)]="Ouest"

d.train$QuartWDir80m=NA
d.train$QuartWDir80m[(d.train$WindDir80m.mean<45)|(d.train$WindDir80m.mean>=315)]="Nord"
d.train$QuartWDir80m[(d.train$WindDir80m.mean<135)&(d.train$WindDir80m.mean>=45)]="Est"
d.train$QuartWDir80m[(d.train$WindDir80m.mean<225)&(d.train$WindDir80m.mean>=135)]="Sud"
d.train$QuartWDir80m[(d.train$WindDir80m.mean<315)&(d.train$WindDir80m.mean>=225)]="Ouest"

d.train$QuartWDir900mb=NA
d.train$QuartWDir900mb[(d.train$WindDir900mb.mean<45)|(d.train$WindDir900mb.mean>=315)]="Nord"
d.train$QuartWDir900mb[(d.train$WindDir900mb.mean<135)&(d.train$WindDir900mb.mean>=45)]="Est"
d.train$QuartWDir900mb[(d.train$WindDir900mb.mean<225)&(d.train$WindDir900mb.mean>=135)]="Sud"
d.train$QuartWDir900mb[(d.train$WindDir900mb.mean<315)&(d.train$WindDir900mb.mean>=225)]="Ouest"


theme_set(theme_classic()+theme(plot.title=element_text(hjust=0.5,size=14,face="bold"),plot.subtitle=element_text(hjust=0.5,size=12),axis.title=element_text(hjust=0.5,size=10)))

# influence de la température
p4=ggplot(data=d.train, mapping=aes(x = Precip.tot,y=Temp.mean,col=pluie.demain)) +
  labs(subtitle="graphe 4", x="Précipitation du jour (mm)", y="Température (°C)",col="Prévision lendemain") +
  geom_point() +
scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

p5=ggplot(data=d.train, mapping=aes(x = pluie.demain, y = Temp.mean, fill = pluie.demain)) +
  geom_boxplot() + 
  labs(subtitle="graphe 5",x="",y="Température (°C)",fill="Prévision lendemain" ) + 
  scale_x_discrete(labels=c("","")) +  
  scale_fill_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))

grid.arrange(p4,p5,ncol=2,top="  Influence de la température du jour sur la prévision météo du lendemain")
  
# influence Précipitation et humidité
p6=ggplot(data=d.train, mapping=aes(x = Precip.tot,y=Humid.mean,col=pluie.demain)) +
  labs(subtitle="graphe 6", x="Précipitation du jour (mm)", y="Humidité (%)",col="Prévision du lendemain") +
  geom_point() +
scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

p7=ggplot(data=d.train, mapping=aes(x = pluie.demain, y = Humid.mean, fill = pluie.demain)) +
  geom_boxplot() + 
  labs(subtitle="graphe 7",x="",y="Humidité (%)",fill="Prévision lendemain" ) + 
  scale_x_discrete(labels=c("","")) +  
  scale_fill_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))

grid.arrange(p6,p7,ncol=2,top="Influence de l'humidité du jour sur la prévision météo du lendemain")

# influence Précipitation et pression atmosphérique
p8=ggplot(data=d.train, mapping=aes(x = Precip.tot,y=Pressure.mean,col=pluie.demain)) +
  labs(subtitle="graphe 8", x="Précipitation du jour (mm)", y="Pression (hPA)",col="Prévision du lendemain") +
  geom_point() +
scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

p9=ggplot(data=d.train, mapping=aes(x = pluie.demain, y = Pressure.mean, fill = pluie.demain)) +
  geom_boxplot() + 
  labs(subtitle="graphe 9",x="",y="Pression (hPA)",fill="Prévision lendemain" ) + 
  scale_x_discrete(labels=c("","")) +  
  scale_fill_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))

grid.arrange(p8,p9,ncol=2,top="Influence de la pression atmosphérique du jour sur la prévision météo du lendemain")


# influence Précipitation et nébulosité
p10=ggplot(data=d.train, mapping=aes(x = Precip.tot,y=TotalCloud.mean,col=pluie.demain)) +
  labs(subtitle="graphe 10", x="Précipitation du jour (mm)", y="Nébulosité (%)",col="Prévision du lendemain") +
  geom_point() +
scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

p11=ggplot(data=d.train, mapping=aes(x = pluie.demain, y = TotalCloud.mean, fill = pluie.demain)) +
  geom_boxplot() + 
  labs(subtitle="graphe 11",x="",y="Nébulosité (%)",fill="Prévision lendemain" ) + 
  scale_x_discrete(labels=c("","")) +  
  scale_fill_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))

grid.arrange(p10,p11,ncol=2,top="Influence de la nébulosité du jour sur la prévision météo du lendemain")


# influence Précipitation et ensoleillement

p12=ggplot(data=d.train, mapping=aes(x = Precip.tot,y=Sunshine.tot,col=pluie.demain)) +
  labs(subtitle="graphe 12", x="Précipitation du jour (mm)", y="Ensoleillement (minute)",col="Prévision du lendemain") +
  geom_point() +
scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

p13=ggplot(data=d.train, mapping=aes(x = pluie.demain, y = Sunshine.tot, fill = pluie.demain)) +
  geom_boxplot() + 
  labs(subtitle="graphe 13",x="",y="Ensoleillement (minute)",fill="Prévision lendemain" ) + 
  scale_x_discrete(labels=c("","")) +  
  scale_fill_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))

grid.arrange(p12,p13,ncol=2,top="Influence de l'ensoleillement du jour sur la prévision météo du lendemain")

# influence Précipitation et rafale de vent
p14=ggplot(data=d.train, mapping=aes(x = Precip.tot,y=WindGust.max,col=pluie.demain)) +
  labs(subtitle="graphe 14", x="Précipitation du jour (mm)", y="Rafale de vent max (km/h)",col="Prévision du lendemain") +
  geom_point() +
scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

p15=ggplot(data=d.train, mapping=aes(x = pluie.demain, y = WindGust.max, fill = pluie.demain)) +
  geom_boxplot() + 
  labs(subtitle="graphe 15",x="",y="Rafale de vent max(km/h)",fill="Prévision lendemain" ) + 
  scale_x_discrete(labels=c("","")) +  
  scale_fill_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))

grid.arrange(p14,p15,ncol=2,top="Influence des rafales de vent du jour sur la prévision météo du lendemain")

# précipitations du jour et sens du vent
p16=ggplot(data=d.train, mapping=aes(x = QuartWDir10m, y =Precip.tot )) +
  labs(subtitle="graphe 16 ", y="Précipitation du jour (mm)", x="Dir.à 10m altitude") + geom_boxplot(fill="blue") 

p17=ggplot(data=d.train, mapping=aes(x = QuartWDir80m, y =Precip.tot )) +
  labs(subtitle="graphe 17", y="", x="Dir.à 80m altitude") + geom_boxplot(fill="blue")

p18=ggplot(data=d.train, mapping=aes(x = QuartWDir900mb, y =Precip.tot )) +
  labs(subtitle="graphe 18", y="", x="Dir.à pression de 900hPA") + geom_boxplot(fill="blue")

grid.arrange(p16,p17,p18,ncol=3,top="Influence de la direction du vent sur les précipitations du jour")

# Prediction météo du lendemain et sens du vent
# vent à 10m altitude

# Météo du jour
p19=ggplot(data=d.train, mapping=aes(x = QuartWDir10m , y =WindSpeed10m.mean, col=pluie.auj, size=10 )) +
  labs(subtitle="graphe 19", y="Vitesse du vent (km/h)", x="Direction du vent", col="Météo du jour") + 
  geom_point(size=5) +
 scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

# Météo du lendemain
p20=ggplot(data=d.train, mapping=aes(x = QuartWDir10m , y =WindSpeed10m.mean, col=pluie.demain )) +
  labs(subtitle="graphe 20", y=" ", x="Direction du vent", col="Météo du lendemain", size="" ) + 
  geom_point(size=5) +
 scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))
   
grid.arrange(p19,p20,ncol=2,top="Influence du vent à 10 m d'altitude")

# Prediction météo du lendemain et sens du vent
# vent à 80m altitude

# Météo du jour
p21=ggplot(data=d.train, mapping=aes(x = QuartWDir80m , y =WindSpeed80m.mean, col=pluie.auj, size=10 )) +
  labs(subtitle="graphe 21", y="Vitesse du vent (km/h)", x="Direction du vent", col="Météo du jour") + 
  geom_point(size=5) +
 scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

# Météo du lendemain
p22=ggplot(data=d.train, mapping=aes(x = QuartWDir80m , y =WindSpeed80m.mean, col=pluie.demain )) +
  labs(subtitle="graphe 22", y=" ", x="Direction du vent", col="Météo du lendemain", size="" ) + 
  geom_point(size=5) +
 scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))
   
grid.arrange(p21,p22,ncol=2,top="Influence du vent à 80 m d'altitude")


# Prediction météo du lendemain et sens du vent
# vent à 900hPA

# Météo du jour
p23=ggplot(data=d.train, mapping=aes(x = QuartWDir900mb , y =WindSpeed900mb.mean, col=pluie.auj, size=10 )) +
  labs(subtitle="graphe 23", y="Vitesse du vent (km/h)", x="Direction du vent", col="Météo du jour") + 
  geom_point(size=5) +
 scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse")) 

# Météo du lendemain
p24=ggplot(data=d.train, mapping=aes(x = QuartWDir900mb , y =WindSpeed900mb.mean, col=pluie.demain )) +
  labs(subtitle="graphe 24", y=" ", x="Direction du vent", col="Météo du lendemain", size="" ) + 
  geom_point(size=5) +
 scale_color_manual(values=c("yellow","blue"),label=c("journée sans pluie","journée pluvieuse"))
   
grid.arrange(p23,p24,ncol=2,top="Influence du vent à une pression de 900 hPA")

```

# Choix du modèle 

Il s'agit maintenant de trouver un modèle qui explique de façon satisfaisante la prévision "pluie.demain". Nous avons à disposition 46 variables explicatives. Il est donc trop fatidieux de tester tous les modèles possibles.
Essayons de vérifier quelques corrélations intuitives permettant de ne pas selectionner des variables redondantes.

## Vérification de corrélations

Testons les corrélations entre les variables de nébulosité, de vitesse de vent, de direction du vent.   
Il apparait des corrélations statistiquement significatives (p-value de cor.test<5%) entre les variables de direction du vent (entre 10m, 80m d'altitude et sous 900HPA), de vitesse du vent (entre 10m, 80m d'altitude, sous 900HPA), de rafale de vent, de nébulosité (totale / forte / médium / faible).
   
```{r cor}
# Tests de corrélation

#Pression
# test de correlation
#cor.test(d.train$Pressure.mean,d.train$Pressure.max)$p.value
#cor.test(d.train$Pressure.mean,d.train$Pressure.min)$p.value
#cor.test(d.train$Pressure.max,d.train$Pressure.min)$p.value

#coefficients de correlation
#Prcormomo=cor(d.train$Pressure.mean,d.train$Pressure.mean, method="pearson")
#Prcormama=cor(d.train$Pressure.max,d.train$Pressure.max, method="pearson")
#Prcormimi=cor(d.train$Pressure.min,d.train$Pressure.min, method="pearson")
#Prcormimo=cor(d.train$Pressure.min,d.train$Pressure.mean, method="pearson")
#Prcormima=cor(d.train$Pressure.min,d.train$Pressure.max,method="pearson")
#Prcormoma=cor(d.train$Pressure.mean,d.train$Pressure.max,method="pearson")

#table_cordir=data.frame(Pression=c("min","moy","max"),Pression.min= c(Prcormimi,Prcormimo,Prcormima),Pression.moy=c(Prcormimo,Prcormomo,Prcormoma),Pression.max#c(Prcormima,Prcormoma,Prcormama))
                     
#kable(head(table_cordir),format="markdown",caption="correlation des var direction du vent",digits=2)

#Direction du vent
# test de correlation
#cor.test(d.train$WindDir10m.mean,d.train$WindDir80m.mean)$p.value
#cor.test(d.train$WindDir10m.mean,d.train$WindDir900mb.mean)$p.value
#cor.test(d.train$WindDir80m.mean,d.train$WindDir900mb.mean)$p.value

#coefficients de correlation
WDcor10m10m=cor(d.train$WindDir10m.mean,d.train$WindDir10m.mean, method="pearson")
WDcor80m80m=cor(d.train$WindDir80m.mean,d.train$WindDir80m.mean, method="pearson")
WDcor900900=cor(d.train$WindDir900mb.mean,d.train$WindDir900mb.mean, method="pearson")
WDcor10m80m=cor(d.train$WindDir10m.mean,d.train$WindDir80m.mean, method="pearson")
WDcor10m900=cor(d.train$WindDir10m.mean,d.train$WindDir900mb.mean,method="pearson")
WDcor80m900=cor(d.train$WindDir80m.mean,d.train$WindDir900mb.mean,method="pearson")

table_cordir=data.frame(Direction_Vent=c("10m","80m","900HPa"),a_10m= c(WDcor10m10m,WDcor10m80m,WDcor10m900),a_80m=c(WDcor10m80m,WDcor80m80m,WDcor80m900),sous_900Hpa=c(WDcor10m900,WDcor80m900,WDcor900900))
                     
kable(head(table_cordir),format="markdown",caption="correlation des var direction du vent",digits=2)

#Vitesse du vent
# test de correlation
#cor.test(d.train$WindSpeed10m.mean,d.train$WindSpeed80m.mean,method="pearson")$p.value
#cor.test(d.train$WindSpeed10m.mean,d.train$WindSpeed900mb.mean,method="pearson")$p.value
#cor.test(d.train$WindSpeed80m.mean,d.train$WindSpeed900mb.mean,method="pearson")$p.value

#coefficients de correlation
WScor10m10m=cor(d.train$WindSpeed10m.mean,d.train$WindSpeed10m.mean,method="pearson")
WScor80m80m=cor(d.train$WindSpeed80m.mean,d.train$WindSpeed80m.mean,method="pearson")
WScor900900=cor(d.train$WindSpeed900mb.mean,d.train$WindSpeed900mb.mean,method="pearson")
WScor10m80m=cor(d.train$WindSpeed10m.mean,d.train$WindSpeed80m.mean,method="pearson")
WScor10m900=cor(d.train$WindSpeed10m.mean,d.train$WindSpeed900mb.mean,method="pearson")
WScor80m900=cor(d.train$WindSpeed80m.mean,d.train$WindSpeed900mb.mean,method="pearson")

table_corvit=data.frame(Vitesse_Vent=c("10m","80m","900HPa"),a_10m=c(WScor10m10m,WScor10m80m,WScor10m900), a_80m=c(WScor10m80m,WScor80m80m,WScor80m900),sous_900HPa=c(WScor10m900,WScor80m900,WScor900900))
kable(head(table_corvit), format="markdown",caption="correlation des var vitesse du vent", digits=2)

#Rafale de vent
# test de correlation
#cor.test(d.train$WindGust.min,d.train$WindGust.mean,method="pearson")$p.value
#cor.test(d.train$WindGust.min,d.train$WindGust.max,method="pearson")$p.value
#cor.test(d.train$WindGust.mean,d.train$WindGust.max,method="pearson")$p.value

#coefficients de correlation
WGcorminmin=cor(d.train$WindGust.min,d.train$WindGust.min,method="pearson")
WGcormaxmax=cor(d.train$WindGust.max,d.train$WindGust.max,method="pearson")
WGcormoymoy=cor(d.train$WindGust.mean,d.train$WindGust.mean,method="pearson")
WGcorminmean=cor(d.train$WindGust.min,d.train$WindGust.mean,method="pearson")
WGcorminmax=cor(d.train$WindGust.min,d.train$WindGust.max,method="pearson")
WGcormeanmax=cor(d.train$WindGust.mean,d.train$WindGust.max,method="pearson")

table_corraf=data.frame(Rafale_Vent=c("min","moy","max"),min=c(WGcorminmin,WGcorminmean,WGcorminmax), moy=c(WGcorminmean,WGcormoymoy,WGcormeanmax),max=c(WGcorminmax,WGcormeanmax,WGcormaxmax))
kable(head(table_corraf), format="markdown",caption="correlation des var rafale de vent",digits=2)

#Nébulosité
#tests de correlation
#cor.test(d.train$TotalCloud.mean,d.train$HighCloud.mean,method="pearson")$p.value
#cor.test(d.train$TotalCloud.mean,d.train$MediumCloud.mean,method="pearson")$p.value
#cor.test(d.train$TotalCloud.mean,d.train$LowCloud.mean,method="pearson")$p.value
#cor.test(d.train$MediumCloud.mean,d.train$HighCloud.mean,method="pearson")$p.value
#cor.test(d.train$LowCloud.mean,d.train$HighCloud.mean,method="pearson")$p.value
#cor.test(d.train$MediumCloud.mean,d.train$LowCloud.mean,method="pearson")$p.value

#coefficients de correlation
Clcortot=cor(d.train$TotalCloud.mean,d.train$TotalCloud.mean,method="pearson")
Clcorhigh=cor(d.train$HighCloud.mean,d.train$HighCloud.mean,method="pearson")
Clcormedium=cor(d.train$MediumCloud.mean,d.train$MediumCloud.mean,method="pearson")
Clcorlow=cor(d.train$LowCloud.mean,d.train$LowCloud.mean,method="pearson")

Clcortothigh=cor(d.train$TotalCloud.mean,d.train$HighCloud.mean,method="pearson")
Clcortotmed=cor(d.train$TotalCloud.mean,d.train$MediumCloud.mean,method="pearson")
Clcortotlow=cor(d.train$TotalCloud.mean,d.train$LowCloud.mean,method="pearson")
Clcorhighmed=cor(d.train$MediumCloud.mean,d.train$HighCloud.mean,method="pearson")
Clcorhighlow=cor(d.train$LowCloud.mean,d.train$HighCloud.mean,method="pearson")
Clcormedlow=cor(d.train$MediumCloud.mean,d.train$LowCloud.mean,method="pearson")

table_corcloud=data.frame(Nebulosite_Moyenne=c("Totale","Forte","Medium","Faible"),Totale=c(Clcortot,Clcortothigh,Clcortotmed,Clcortotlow),Forte=c(Clcortothigh,Clcorhigh,Clcorhighmed,Clcorhighlow), Medium=c(Clcortotmed,Clcorhighmed,Clcormedium,Clcormedlow), Faible=c(Clcortotlow,Clcorhighlow,Clcormedlow,Clcorlow))
kable(head(table_corcloud), format="markdown", caption="correlation des var nébulosité",digits=2)

```

Des corrélations fortes existent entre : 

   + les directions du vent à 10m et à 80m    
   + les vitesses de vent à 10m, à 80m et sous 900HPa  
   + les rafales de vent minimum et moyenne  
   + les nébulosités totale, faible et médium  
   + les nébulosités forte et médium  
    
## Méthode "exhaustive" 
Dans un premier temps, utilisons une méthode de choix de modèle "manuelle" en sélectionnant les variables explicatives semblant pertinentes sur la base des influences et correlations observées. Les critères R2, R2 ajusté, CP Mallows, BIC permettent d'identifier les variables à choisir. (min CP Mallows et min BIC)

Illustration de la démarche en testant plusieurs modèles.

  - **Modèle 1** : 10 variables explicatives (choisies à partir des corrélations et influences observées précédemment).  
       + pression moyenne,   
       + précipitation,
       + nébulosités totale et forte,   
       + vitesse moyenne du vent à 10m,  
       + direction du vent à 10m et sous 900hPa, 
       + ensoleillement  
       + rafale minimum et maximum
    
```{r choixman1 }
choixman_mod1=regsubsets(pluie.demain.bin~Pressure.mean+Precip.tot+TotalCloud.mean+HighCloud.mean+WindSpeed10m.mean+WindDir10m.mean+WindDir900mb.mean+Sunshine.tot+WindGust.max+WindGust.min,int=T,nbest=1,nvmax=10,method="exhaustive",data=d.train)

plot(choixman_mod1,scale = "Cp",col="green", main="Modèle 1 - Cp Mallows")
plot(choixman_mod1,scale = "bic", col="green", main="Modèle 1 - BIC")

```
**Résultat Modèle 1 :**   
Les précipitations et l'ensoleillement semblent être des variables peu pertinentes pour expliquer les prévisions météo du lendemain.   
    
  - **Modèle 2** : 8 variables explicatives : remplacement de la variable vitesse de vent à 10m altitude par celle sous 900hPA et suppresion des variables ensoleillement et précipitation
    + pression moyenne,   
    + nébulosités totale et forte,   
    + vitesse maximum du vent sous 900hPA,  
    + direction du vent à 10m et sous 900hPA,  
    + rafales de vent max  et min 

```{r choixman2 }

choixman_mod2=regsubsets(pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min,int=T,nbest=1,nvmax=8,method="exhaustive",data=d.train)

plot(choixman_mod2,scale = "Cp",col="green", main="Modèle 2 - Cp Mallows")
plot(choixman_mod2,scale = "bic", col="green", main="Modèle 2 - BIC")

```
**Résultat Modèle 2** :  
Après observation des résultats sur les modèles 1 et 2, on constate que les 4 variables les plus pertinentes sont la pression atmosphérique, les nébulosité totale et forte, la direction du vent sous 900HPa.   

  - **Modèle 3** : 4 variables explicatives (modèle minimal : selection des variables min BIC et AIC)
    + pression moyenne,   
    + nébulosité totale et forte,   
    + direction du vent sous 900hPA  
    
```{r choixman3 }
choixman_mod3=regsubsets(pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindDir900mb.mean,int=T,nbest=1,nvmax=4,method="exhaustive",data=d.train)


plot(choixman_mod3,scale = "Cp",col="green", main="Modèle 3 - Cp Mallows")
plot(choixman_mod3,scale = "bic", col="green", main="Modèle 3 - BIC")

```
** Résultat Modèle 3 ** :  
Les 4 variables du modèle 3 confirment leur pertinence à expliquer la météo du lendemain.  
Testons un modèle plus complet en introduisant le rayonnement solaire au modèle 2.   
    

- **Modèle 4** : 9 variables explicatives : modèle 2 +rayonnement solaire
    + pression moyenne,   
    + rayonnement solaire,
    + nébulosités totale et forte,   
    + vitesse maximum du vent sous 900hPA,  
    + direction du vent à 10m et sous 900hPA, 
    + rafales de vent max, min

```{r choixman4 }

choixman_mod4=regsubsets(pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min, int=T,nbest=1,nvmax=9,method="exhaustive",data=d.train)

plot(choixman_mod4,scale = "Cp",col="green", main="Modèle 4 - Cp Mallows")
plot(choixman_mod4,scale = "bic", col="green", main="Modèle 4 - BIC")
```

- **Modèle 5** : 11 variables explicatives : modèle 4 + neige + humidité moyenne
    + pression moyenne,   
    + rayonnement solaire,
    + nébulosités totale et forte,   
    + vitesse maximum du vent sous 900hPA,  
    + direction du vent à 10m et sous 900hPA, 
    + rafales de vent max et min
    + neige
    + humidité moyenne


```{r choixman5 }

choixman_mod5=regsubsets(pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min+Snow.tot+Humid.mean, int=T,nbest=1,nvmax=11,method="exhaustive",data=d.train)

plot(choixman_mod5,scale = "Cp",col="green", main="Modèle 5 - Cp Mallows")
plot(choixman_mod5,scale = "bic", col="green", main="Modèle 5 - BIC")
```


## Méthode "progressive"

Dans cette étape, pour choisir les variables explicatives du modèle, nous allons utiliser une des méthodes pas à pas : la méthode progressive. Elle consiste, à chaque itération, à ajouter au modèle une variable explicative (celle avec le plus petit AIC et tel que cet AIC soit inférieur à l'AIC du modèle nul) et à remettre en cause les variables intégrées aux itérations précédentes.  

Le modèle utilisé sera le modèle logistique : en effet, il permet d'expliquer une variable binaire (présence de pluie ou non demain) en fonction de variables explicatives sélectionnées.   
  En R : *glm ( pluie.demain ~ variables explicatives, family = binomial )*

Commençons par tester le modèle 1 (cf.methode exhaustive).

- **Modèle 1** : 10 variables explicatives proposées

**Déroulement de la sélection de variables** :

  + Etape 1 : le critère AIC de la variable pression atmosphérique est le plus bas et est inférieur à l'AIC de référence (none).  
    => choix de la variable pression atmosphérique comme variable explicative    
    
  + Etape 2 : le critère AIC de la variable direction du vent sous 900HPa est le plus bas et est inférieur à l'AIC de référence (none).   
             => choix de la variable direction du vent sous 900HPa comme variable explicative
    
  + Etape 3 : => choix de la variable nébulosité forte  comme variable explicative
    
  + Etape 4 : => choix de la variable nébulosité totale comme variable explicative 
  
  + Etape 5 : => choix de la variable rafale maximum comme variable explicative
  
  + Etape 6 : => choix de la variable vitesse du vent à 10m comme variable explicative
  
  + Etape 7 : les AIC  des variables restantes sont supérieurs à AIC de référence   
             => sélection de variables explicatives est terminée.  
    
**Résultat Modèle 1** : 6 variables sont sélectionnées

  + pression atmosphérique, 
  + direction du vent sous 900hPA,
  + nébulosités totale et forte 
  + rafale de vent max
  + vitesse du vent à 10m
    
 
```{r choixprog_mod1}
# modèle 1
step(glm(pluie.demain.bin~1,data=d.train,family=binomial),pluie.demain.bin~Pressure.mean+Precip.tot+TotalCloud.mean+HighCloud.mean+WindSpeed10m.mean+WindDir10m.mean+WindDir900mb.mean+Sunshine.tot+WindGust.max+WindGust.min,data=d.train,direction="both")

mod1=glm(pluie.demain.bin~Pressure.mean+Precip.tot+TotalCloud.mean+HighCloud.mean+WindSpeed10m.mean+WindDir10m.mean+WindDir900mb.mean+Sunshine.tot+WindGust.max+WindGust.min,data=d.train,family=binomial)

#aic
aic_mod1=AIC(mod1)
#deviance residuelle
deviance_mod1=deviance(mod1)
#degres de liberté deviance résiduelle
dfdeviance_mod1=df.residual(mod1)

#modèle sans covariable
mod0=glm(pluie.demain.bin~1,data=d.train,family=binomial)
#aic
aic_mod0=AIC(mod0)
#deviance nulle
deviance_mod0=deviance(mod0)
#degres de liberté deviance nulle
dfdeviance_mod0=df.residual(mod0)


```

- **Modèle 2** : 8 variables explicatives proposées

**Résultat Modèle 2** : 5 variables sont selectionnées

   + pression atmosphérique, 
   + direction du vent sous 900hPA,
   + nébulosités totale et forte,
   + vitesse du vent à 900HPa

```{r choixprog_mod2}
# modèle 2
step(glm(pluie.demain.bin~1,data=d.train,family=binomial),pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min,data=d.train,direction="both")

mod2=glm(pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min,data=d.train,family=binomial)

#aic
aic_mod2=AIC(mod2)
#deviance residuelle
deviance_mod2=deviance(mod2)
#degres de liberté deviance résiduelle
dfdeviance_mod2=df.residual(mod2)

```


  - **Modèle 3** : 4 variables explicatives proposées  
  
**Résultat Modèle 3** : Toutes les variables sont sélectionnées.   
  
  + pression atmosphérique, 
  + direction du vent sous 900hPA,
  + nébulosités totale et forte  
    
```{r choixprog_mod3}

# modèle 3
step(glm(pluie.demain.bin~1,data=d.train,family=binomial),pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindDir900mb.mean,data=d.train,direction="both")

mod3=glm(pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindDir900mb.mean,data=d.train,family=binomial)

#aic
aic_mod3=AIC(mod3)
#deviance residuelle
deviance_mod3=deviance(mod3)
#degres de liberté deviance résiduelle
dfdeviance_mod3=df.residual(mod3)


```

  - **Modèle 4** : 9 variables explicatives proposées 
    
**Résultat Modèle 4** : 7 variables sont selectionnées

   + pression atmosphérique, 
   + direction du vent sous 900hPA et à 10m,
   + nébulosités totale et forte,  
   + vitesse du vent à 900HPa,
   + rayonnement solaire
  
```{r choixprog_mod4}

# modèle 4
step(glm(pluie.demain.bin~1,data=d.train,family=binomial),pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min,data=d.train,direction="both")

mod4=glm(pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min,data=d.train,family=binomial)

#aic
aic_mod4=AIC(mod4)
#deviance residuelle
deviance_mod4=deviance(mod4)
#degres de liberté deviance résiduelle
dfdeviance_mod4=df.residual(mod4)


```

  - **Modèle 5** : 11 variables explicatives proposées
  
  **Résultat Modèle 5** : 8 variables sont selectionnées 

   + pression atmosphérique, 
   + direction du vent sous 900hPA et à 10m,
   + nébulosités totale et forte,  
   + rafale de vent maximum,
   + neige,
   + rayonnement solaire
    
```{r choixprog_mod5}

# modèle 5
step(glm(pluie.demain.bin~1,data=d.train,family=binomial),pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min+Snow.tot+Humid.mean,data=d.train,direction="both")

mod5=glm(pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+WindGust.max+WindGust.min+Snow.tot+Humid.mean,data=d.train,family=binomial)

#aic
aic_mod5=AIC(mod5)
#deviance residuelle
deviance_mod5=deviance(mod5)
#degres de liberté deviance résiduelle
dfdeviance_mod5=df.residual(mod5)


```



```{r crit}

table_res2=data.frame(Modele=c("Modèle nul","Modèle 1","Modèle 2","Modèle 3","Modèle 4","Modèle 5"),AIC=c(aic_mod0,aic_mod1,aic_mod2,aic_mod3,aic_mod4,aic_mod5),Deviance=c(deviance_mod0,deviance_mod1,deviance_mod2,deviance_mod3,deviance_mod4,deviance_mod5),Df=c(dfdeviance_mod0,dfdeviance_mod1,dfdeviance_mod2,dfdeviance_mod3,dfdeviance_mod4,dfdeviance_mod5))
                     
kable(head(table_res2), format="markdown", digits=0)

```
**Resultat de la méthode progressive* :   
Les meilleurs modèles sont les 4 et 5  : ils présentent le critère AIC le plus bas   
    
    
# Validation du modèle 

##Test de la déviance  
Il s'agit de comparer :     
 
   - le modèle choisi au modèle nul (sans covariable) sur le critère de la déviance.   
Si la p-valeur du test de chi2 (D0 : déviance modèle nul - Dk : déviance modèle choisi, dfD0 - dfDk ) < 5%, on rejette le modèle nul.  

   - le modèle choisi au modèle saturé (avec l'ensemble des covariables) sur le critère de la déviance.   
Si la p-valeur du test de chi2 (Dk : déviance modèle choisi, dfDk ) < 5%, on rejette le modèle choisi.
   

```{r testdeviance_mod1}
# Modèle 1 
# test par rapport au modèle sans covariable
pchisq0_mod1=pchisq(deviance_mod0 - deviance_mod1, dfdeviance_mod0 - dfdeviance_mod1, lower = F)
# test par rapport au modèle saturé
pchisqsat_mod1=pchisq(deviance_mod1, dfdeviance_mod1, lower = F)

# Modèle 2
# test par rapport au modèle sans covariable
pchisq0_mod2=pchisq(deviance_mod0 - deviance_mod2, dfdeviance_mod0 - dfdeviance_mod2, lower = F)
# test par rapport au modèle saturé
pchisqsat_mod2=pchisq(deviance_mod2, dfdeviance_mod2, lower = F)

# Modèle 3 
# test par rapport au modèle sans covariable
pchisq0_mod3=pchisq(deviance_mod0 - deviance_mod3, dfdeviance_mod0 - dfdeviance_mod3, lower = F)
# test par rapport au modèle saturé
pchisqsat_mod3=pchisq(deviance_mod3, dfdeviance_mod3, lower = F)

# Modèle 4 
# test par rapport au modèle sans covariable
pchisq0_mod4=pchisq(deviance_mod0 - deviance_mod4, dfdeviance_mod0 - dfdeviance_mod4, lower = F)
# test par rapport au modèle saturé
pchisqsat_mod4=pchisq(deviance_mod4, dfdeviance_mod4, lower = F)

# Modèle 5 
# test par rapport au modèle sans covariable
pchisq0_mod5=pchisq(deviance_mod0 - deviance_mod5, dfdeviance_mod0 - dfdeviance_mod5, lower = F)
# test par rapport au modèle saturé
pchisqsat_mod5=pchisq(deviance_mod5, dfdeviance_mod5, lower = F)


table_res3=data.frame(Modele=c("Modèle 1","Modèle 2","Modèle 3","Modèle 4","Modèle 5"),pvalue.Deviance.nulle=c(pchisq0_mod1,pchisq0_mod2,pchisq0_mod3,pchisq0_mod4,pchisq0_mod5),pvalue.Deviance.saturee=c(pchisqsat_mod1,pchisqsat_mod2,pchisqsat_mod3,pchisqsat_mod4,pchisqsat_mod5))
                     
kable(head(table_res3), format="markdown", digits=4)

```

##Test anova
Il s'agit de comparer 2 modèles imbriqués et de déterminer le "meilleur" des 2 modèles à partir de la p_value du test. si la p-value est < au seuil (ex: 5%) alors le modèle avec le plus de covariables est le meilleur.

 - Modèle 2 vs Modèle 3 :   
 p-valeur > 5%, le meilleur modèle est celui avec le moins de covariables : le modèle 3

```{r anova1}
anova(mod2, mod3, test = "LRT")
```

 - Modèle 3 vs Modèle 4 :     
 p-valeur > 5%, le meilleur modèle est celui avec le moins de covariables : le modèle 3

```{r anova2}
anova(mod3, mod4, test = "LRT")

``` 

- Modèle 3 vs Modèle 5 :   
p-valeur < 5%, le meilleur modèle est celui avec le plus de covariables : le modèle 5

```{r anova3}
anova(mod3, mod5, test = "LRT")

``` 

- Modèle 2 vs Modèle 4 :   
p-valeur < 5%, le meilleur modèle est celui avec le plus de covariables : le modèle 4

```{r anova4}
anova(mod2, mod4, test = "LRT")

``` 

- Modèle 2 vs Modèle 5 :   
p-valeur > 5%, le meilleur modèle est celui 

```{r anova5}
anova(mod2, mod5, test = "LRT")

``` 
##Validation croisée  

Il s'agit de comparer 2 modèles à partir de leur la précision prédictive ; plus la prédiction sera proche de la vraie valeur (moyenne (|prediction-vraie valeur|) est petite), meilleure sera la capacité prédictive du modèle.   
   
```{r validcroi}
# on crée un vecteur de booléens, tirés aléatoirement tels que 80% du jeu de données soit utilisé pour identifier le modèle et 20% pour verifier l'ecart de prédiction
train_80 = sample(c(T, F), nrow(d.train), replace = T, prob = c(.8, .2))
#data=d.train[train_80,]

#prédiction sur le modèle 1
mod1.80=glm(pluie.demain.bin~Pressure.mean+Precip.tot+TotalCloud.mean+HighCloud.mean+WindSpeed10m.mean+WindDir10m.mean+WindDir900mb.mean+Sunshine.tot+WindGust.max+WindGust.min,data=d.train[train_80,],family=binomial)
pred_mod1=predict(mod1.80,d.train[!train_80,],type="response")
mean_mod1=mean(abs(pred_mod1-d.train[!train_80,"pluie.demain.bin"]),na.rm=T)

#prédiction sur le modèle 2
mod2.80=glm(pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+Sunshine.tot+WindGust.max,data=d.train[train_80,],family=binomial)
pred_mod2=predict(mod2.80,d.train[!train_80,],type="response")
mean_mod2=mean(abs(pred_mod2-d.train[!train_80,"pluie.demain.bin"]),na.rm=T) 

#prédiction sur le modèle 3
mod3.80=glm(pluie.demain.bin~Pressure.mean+TotalCloud.mean+HighCloud.mean+WindDir900mb.mean,data=d.train[train_80,],family=binomial)
pred_mod3=predict(mod3.80,d.train[!train_80,],type="response")
mean_mod3=mean(abs(pred_mod3-d.train[!train_80,"pluie.demain.bin"]),na.rm=T)

#prédiction sur le modèle 4
mod4.80=glm(pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindSpeed900mb.max+WindDir10m.mean+WindDir900mb.mean+Sunshine.tot,data=d.train[train_80,],family=binomial)
pred_mod4=predict(mod4.80,d.train[!train_80,],type="response")
mean_mod4=mean(abs(pred_mod4-d.train[!train_80,"pluie.demain.bin"]),na.rm=T)

#prédiction sur le modèle 5
mod5.80=glm(pluie.demain.bin~Pressure.mean+Shortwave.tot+TotalCloud.mean+HighCloud.mean+WindDir10m.mean+WindDir900mb.mean+Sunshine.tot+WindGust.max,data=d.train[train_80,],family=binomial)
pred_mod5=predict(mod5.80,d.train[!train_80,],type="response")
mean_mod5=mean(abs(pred_mod5-d.train[!train_80,"pluie.demain.bin"]),na.rm=T)

table_res4=data.frame(Modele=c("Modèle 1","Modèle 2","Modèle 3","Modèle 4","Modèle 5"),erreur=c(mean_mod1,mean_mod2,mean_mod3,mean_mod4,mean_mod5))
                     
kable(head(table_res4), format="markdown", digits=4)

```

  
##Caractéristiques du modèle choisi  

Le modèle 5 a les caratéristiques suivantes :

```{r affichecoef}

kableExtra::kable(summary(mod5)$coefficients, format="markdown", digits=3) %>%
kable_styling(full_width = F)



```

   
# Prévision de la météo du lendemain 

```{r predic}



```